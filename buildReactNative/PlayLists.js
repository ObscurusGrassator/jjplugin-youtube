var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));module.exports=function(){function PlayLists(options){(0,_classCallCheck2.default)(this,PlayLists);this.previousRecordingIndex=0;this.stoppedAfterAwaking=false;this.recordingPlaying=false;this.options=options;}return(0,_createClass2.default)(PlayLists,[{key:"createNewMarkForRecording",value:function(){var _createNewMarkForRecording=(0,_asyncToGenerator2.default)(function*(mark){if(this.options.config.playLists.recordingMarks.options.includes(mark))return;if(!(yield this.options.getSummaryAccept(this.options.translate.createMark({mark:mark}))))return;this.options.config.playLists.recordingMarks.options.push(mark);yield this.options.configSave();});function createNewMarkForRecording(_x){return _createNewMarkForRecording.apply(this,arguments);}return createNewMarkForRecording;}()},{key:"searchConfigPlayList",value:function searchConfigPlayList(idInPlatform,snippetTitle){var _this=this;var playLists=arguments.length>2&&arguments[2]!==undefined?arguments[2]:this.options.config.playLists.playLists;return playLists.find(function(p){return!idInPlatform&&!p.idInPlatform.value&&p.name.value&&_this.normName(p.name.value)===_this.normName(snippetTitle)||idInPlatform&&p.idInPlatform.value&&p.idInPlatform.value===idInPlatform;});}},{key:"markRecording",value:(function(){var _markRecording=(0,_asyncToGenerator2.default)(function*(recording,playList,marks){var unmark=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;if(!this.searchConfigPlayList(playList.idInPlatform.value,playList.name.value)){var newPlayList=yield this.getPlayList(playList.idInPlatform.value,'playList',playList.name.value,true);if(this.lastPlayedPlayList.playList==playList){this.lastPlayedPlayList.playList=newPlayList;recording=this.lastPlayedPlayList.playList.recordingList.find(function(r){return r.idInPlatform.value==recording.idInPlatform.value;});this.lastPlayedPlayList.recordingIndex=this.lastPlayedPlayList.playList.recordingList.indexOf(recording);}}for(var mark of marks){if(!this.options.config.playLists.recordingMarks.options.includes(mark)&&mark!=='listened')throw`"${mark}" mark is not exists. You must creating it, if it not exists.`;}for(var _mark of marks){if(!unmark&&!recording.marks.value.includes(_mark))recording.marks.value.push(_mark);if(unmark&&recording.marks.value.includes(_mark))recording.marks.value.splice(recording.marks.value.indexOf(_mark),1);}yield this.options.configSave();console.debug('jjplugin: YouTube - marks:',recording.marks.value);});function markRecording(_x2,_x3,_x4){return _markRecording.apply(this,arguments);}return markRecording;}())},{key:"playYouTubeRecording",value:(function(){var _playYouTubeRecording=(0,_asyncToGenerator2.default)(function*(recording){var _this2=this;var fromSecond=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var inLoop=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var disableAsync=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;var startPlaying=arguments.length>4&&arguments[4]!==undefined?arguments[4]:true;var list=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;console.debug('jjplugin: YouTube - playYouTubeRecording(',{recording:{idInPlatform:recording.idInPlatform,name:recording.name,marks:recording.marks.value},fromSecond:fromSecond,inLoop:inLoop,disableAsync:disableAsync,startPlaying:startPlaying,list:list},')');if(startPlaying)yield this.options.browserTab.viewTab();this.recordingPlaying=true;if(!list){this.lastPlayedRecording={recording:recording};this.lastPlayedPlayList=undefined;}yield this.options.browserTab.goToUrl(`https://${this.options.deviceStatus.displayOff?'m':'www'}.yout-ube.com/watch?v=${recording.idInPlatform.value}&loop=0&start=${fromSecond}`);yield new Promise(function(res){return setTimeout(res,3000);});return new Promise(function(){var _ref=(0,_asyncToGenerator2.default)(function*(res,rej){try{var currentTime=0;var retryCount=0;var duration=1;while(currentTime<duration){if(!list&&_this2.lastPlayedRecording.stoppedInSecond!==undefined||list&&_this2.lastPlayedPlayList.stoppedInSecond!==undefined){_this2.recordingPlaying=false;return res();}var tmp=yield _this2.options.browserTab.sendRequest(`async%20(utils%2C%20fromSecond)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(fromSecond)%20%20%20%2F**%20%40type%20%7B%20HTMLVideoElement%20%7D%20*%2F%20(document.querySelector('.video-stream')).currentTime%20%3D%20fromSecond%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20currentTime%20%3D%20%2F**%20%40type%20%7B%20HTMLVideoElement%20%7D%20*%2F%20(document.querySelector('.video-stream')).currentTime%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20duration%20%20%20%20%3D%20%2F**%20%40type%20%7B%20HTMLVideoElement%20%7D%20*%2F%20(document.querySelector('.video-stream')).duration%3B%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%20currentTime%2C%20duration%20%7D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D`,'$*',fromSecond);fromSecond=0;if(typeof tmp.currentTime=='number'&&currentTime>tmp.currentTime){break;}if(typeof tmp.currentTime=='number'&&currentTime===tmp.currentTime)retryCount++;else retryCount=0;if(typeof tmp.currentTime=='number'&&currentTime===tmp.currentTime&&retryCount>3){if(!list)_this2.lastPlayedRecording.stoppedInSecond=currentTime;if(list)_this2.lastPlayedPlayList.stoppedInSecond=currentTime;_this2.options.speech(_this2.options.translate.recordingNotLoading);_this2.options.browserTab.destructor();_this2.recordingPlaying=false;return res();}if((typeof tmp.duration!='number'||typeof tmp.currentTime!='number')&&retryCount>3){if(list)_this2.lastPlayedPlayList.stoppedInSecond=0;_this2.options.speech(_this2.options.translate.recordingNotLoading);_this2.options.browserTab.destructor();_this2.recordingPlaying=false;return res();}currentTime=tmp.currentTime;duration=tmp.duration;if(disableAsync)res();yield new Promise(function(res){_this2.stopResolver=function(){res();_this2.stopResolver=undefined;};setTimeout(function(){return _this2.stopResolver==null?void 0:_this2.stopResolver();},2000);});}if(!list)_this2.lastPlayedRecording.stoppedInSecond=undefined;if(list)_this2.lastPlayedPlayList.stoppedInSecond=undefined;if(list&&_this2.lastPlayedPlayList&&_this2.options.config.playLists.recordingMarks.options.includes('listened')){if(_this2.searchConfigPlayList(_this2.lastPlayedPlayList.playList.idInPlatform.value,_this2.lastPlayedPlayList.playList.name.value))_this2.markRecording(recording,_this2.lastPlayedPlayList.playList,['listened']);}if(inLoop&&!list)return res(yield _this2.playYouTubeRecording(recording,0,inLoop,disableAsync,false));if(!list)_this2.options.browserTab.destructor();return res();}catch(err){rej(err);}});return function(_x6,_x7){return _ref.apply(this,arguments);};}());});function playYouTubeRecording(_x5){return _playYouTubeRecording.apply(this,arguments);}return playYouTubeRecording;}())},{key:"playYouTubePlayList",value:(function(){var _playYouTubePlayList=(0,_asyncToGenerator2.default)(function*(playList){var _this3=this;var _ref2=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},_ref2$fromRecordingIn=_ref2.fromRecordingIndex,fromRecordingIndex=_ref2$fromRecordingIn===void 0?0:_ref2$fromRecordingIn,_ref2$fromSecond=_ref2.fromSecond,fromSecond=_ref2$fromSecond===void 0?0:_ref2$fromSecond,_ref2$withMarks=_ref2.withMarks,withMarks=_ref2$withMarks===void 0?[]:_ref2$withMarks,_ref2$withoutMarks=_ref2.withoutMarks,withoutMarks=_ref2$withoutMarks===void 0?[]:_ref2$withoutMarks,_ref2$shuffleOrder=_ref2.shuffleOrder,shuffleOrder=_ref2$shuffleOrder===void 0?false:_ref2$shuffleOrder,_ref2$inLoop=_ref2.inLoop,inLoop=_ref2$inLoop===void 0?false:_ref2$inLoop;var startPlaying=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;console.debug('jjplugin: YouTube - playYouTubePlayList(',{playList:{idInPlatform:playList.idInPlatform,name:playList.name,recordingListLength:playList.recordingList.length},fromRecordingIndex:fromRecordingIndex,fromSecond:fromSecond,withMarks:withMarks,withoutMarks:withoutMarks,shuffleOrder:shuffleOrder,inLoop:inLoop,startPlaying:startPlaying},')');if(startPlaying){yield this.options.browserTab.viewTab();if(shuffleOrder)this.shuffleArray(playList.recordingList);}this.lastPlayedRecording=undefined;this.lastPlayedPlayList={playList:playList,recordingIndex:fromRecordingIndex,previousRecordingIndex:this.previousRecordingIndex,shuffleOrder:shuffleOrder,inLoop:inLoop};return new Promise(function(){var _ref3=(0,_asyncToGenerator2.default)(function*(res,rej){try{var recorded=0;if(startPlaying)setTimeout(res,1000);rec:while(_this3.lastPlayedPlayList.recordingIndex<=_this3.lastPlayedPlayList.playList.recordingList.length){var recording=playList.recordingList[_this3.lastPlayedPlayList.recordingIndex];for(var mark of withMarks||[]){if(!recording.marks.value.includes(mark)){_this3.lastPlayedPlayList.recordingIndex++;continue rec;}}for(var _mark2 of withoutMarks||[]){if(recording.marks.value.includes(_mark2)){_this3.lastPlayedPlayList.recordingIndex++;continue rec;}}yield _this3.playYouTubeRecording(recording,fromSecond,false,false,false,true);if(_this3.lastPlayedPlayList.stoppedInSecond!==undefined)return;recorded++;fromSecond=0;_this3.previousRecordingIndex=_this3.lastPlayedPlayList.previousRecordingIndex=_this3.lastPlayedPlayList.recordingIndex;_this3.lastPlayedPlayList.recordingIndex++;}if(!recorded){_this3.recordingPlaying=false;yield _this3.options.speech(_this3.options.translate.playListEmpty);}else if(inLoop)return yield _this3.playYouTubePlayList(playList,{fromRecordingIndex:0,fromSecond:0,withMarks:withMarks,withoutMarks:withoutMarks,shuffleOrder:shuffleOrder,inLoop:inLoop},false);else{_this3.recordingPlaying=false;_this3.options.browserTab.destructor();yield _this3.options.speech(_this3.options.translate.playListEnd);}}catch(err){rej(err);}});return function(_x9,_x10){return _ref3.apply(this,arguments);};}());});function playYouTubePlayList(_x8){return _playYouTubePlayList.apply(this,arguments);}return playYouTubePlayList;}())},{key:"continuePlaying",value:function(){var _continuePlaying=(0,_asyncToGenerator2.default)(function*(){var continueAfterAsleep=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(continueAfterAsleep&&!this.stoppedAfterAwaking)return;this.stoppedAfterAwaking=false;if(this.recordingPlaying)return;yield this.options.browserTab.viewTab();if(this.lastPlayedRecording)yield this.playYouTubeRecording(this.lastPlayedRecording.recording,this.lastPlayedRecording.stoppedInSecond);if(this.lastPlayedPlayList)yield this.playYouTubePlayList(this.lastPlayedPlayList.playList,{fromRecordingIndex:this.lastPlayedPlayList.recordingIndex,fromSecond:this.lastPlayedPlayList.stoppedInSecond,shuffleOrder:this.lastPlayedPlayList.shuffleOrder,inLoop:this.lastPlayedPlayList.inLoop});});function continuePlaying(){return _continuePlaying.apply(this,arguments);}return continuePlaying;}()},{key:"stopPlaying",value:function(){var _stopPlaying=(0,_asyncToGenerator2.default)(function*(){var _this$stopResolver;var stoppedAfterAwaking=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(!stoppedAfterAwaking&&this.stoppedAfterAwaking){this.stoppedAfterAwaking=false;this.options.browserTab.destructor();return;}if(!this.recordingPlaying)return;this.stoppedAfterAwaking=stoppedAfterAwaking;var _yield$this$options$b=yield this.options.browserTab.sendRequest(`async%20utils%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20let%20currentTime%20%3D%20%2F**%20%40type%20%7B%20HTMLVideoElement%20%7D%20*%2F%20(document.querySelector('.video-stream')).currentTime%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20let%20duration%20%20%20%20%3D%20%2F**%20%40type%20%7B%20HTMLVideoElement%20%7D%20*%2F%20(document.querySelector('.video-stream')).duration%3B%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F**%20%40type%20%7B%20HTMLVideoElement%20%7D%20*%2F%20(document.querySelector('.video-stream')).pause()%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%20currentTime%2C%20duration%20%7D%3B%0A%20%20%20%20%20%20%20%20%7D`,'$*'),currentTime=_yield$this$options$b.currentTime,duration=_yield$this$options$b.duration;if(currentTime>5&&currentTime!==duration)currentTime-=5;if(this.lastPlayedRecording)this.lastPlayedRecording.stoppedInSecond=currentTime;if(this.lastPlayedPlayList)this.lastPlayedPlayList.stoppedInSecond=currentTime;(_this$stopResolver=this.stopResolver)==null?void 0:_this$stopResolver.call(this);this.recordingPlaying=false;this.options.browserTab.destructor();});function stopPlaying(){return _stopPlaying.apply(this,arguments);}return stopPlaying;}()},{key:"qualityChange",value:function(){var _qualityChange=(0,_asyncToGenerator2.default)(function*(quality){yield this.options.browserTab.sendRequest(`async%20utils%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F**%20%40type%20%7B%20HTMLButtonElement%20%7D%20*%2F%20(await%20utils.waitForElement('.ytp-settings-button')).click()%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F**%20%40type%20%7B%20HTMLButtonElement%20%7D%20*%2F%20(await%20utils.waitForElement('.ytp-menuitem%3Alast-child')).click()%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(quality%20%3D%3D%20'low')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F**%20%40type%20%7B%20HTMLButtonElement%20%7D%20*%2F%20(document.querySelector('.ytp-menuitem%3Anth-last-child(2)')).click()%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(quality%20%3D%3D%20'auto')%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F**%20%40type%20%7B%20HTMLButtonElement%20%7D%20*%2F%20(document.querySelector('.ytp-menuitem%3Anth-last-child(6)')).click()%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20await%20new%20Promise(res%20%3D%3E%20setTimeout(res%2C%201000))%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F**%20%40type%20%7B%20HTMLButtonElement%20%7D%20*%2F%20(document.querySelector('.ytp-menuitem%3Anth-last-child(1)')).click()%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D`,'$*',quality);});function qualityChange(_x11){return _qualityChange.apply(this,arguments);}return qualityChange;}()},{key:"createPlayList",value:function(){var _createPlayList=(0,_asyncToGenerator2.default)(function*(name){name=name.charAt(0).toLocaleUpperCase()+name.substring(1);console.debug('jjplugin: YouTube - createPlayList('+name+')');if(this.searchConfigPlayList('',name)){this.options.speech(this.options.translate.playListExists);return;}else if(!(yield this.options.getSummaryAccept(this.options.translate.playListCreate({name:name}))))return;var plo=this.options.config.playLists.playLists[0];var now=new Date().toISOString().match(/^(\d\d\d\d)-(\d\d)-(\d\d)T/);var nowTime=`${now[1]}.${now[2]}.${now[3]}`;var newPlayList={platform:Object.assign({},plo.platform,{value:'YouTube'}),idInPlatform:Object.assign({},plo.idInPlatform,{value:''}),name:Object.assign({},plo.idInPlatform,{value:name}),updatedAt:Object.assign({},plo.updatedAt,{value:nowTime}),setMassStatus:Object.assign({},plo.setMassStatus),reloadEveryHours:Object.assign({},plo.reloadEveryHours),recordingList:[]};this.options.config.playLists.playLists.push(newPlayList);yield this.options.configSave();return newPlayList;});function createPlayList(_x12){return _createPlayList.apply(this,arguments);}return createPlayList;}()},{key:"normName",value:function normName(name){return name.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();}},{key:"addToPlayList",value:function(){var _addToPlayList=(0,_asyncToGenerator2.default)(function*(idInPlatform,idType,snippetTitle,toPlayList){console.debug('jjplugin: YouTube - addToPlayList('+idInPlatform+": "+snippetTitle+" --> "+toPlayList.idInPlatform.value+": "+toPlayList.name.value+')');var configPlayList=this.searchConfigPlayList(toPlayList.idInPlatform.value,toPlayList.name.value);if(toPlayList.idInPlatform.value&&!configPlayList){var newPlayList=yield this.getPlayList(toPlayList.idInPlatform.value,'playList',toPlayList.name.value,true);if(this.lastPlayedPlayList.playList==toPlayList)this.lastPlayedPlayList.playList=newPlayList;configPlayList=this.searchConfigPlayList(toPlayList.idInPlatform.value,toPlayList.name.value);}var plo=this.options.config.playLists.playLists[0];var plro=plo.recordingList[0];var now=new Date().toISOString().match(/^(\d\d\d\d)-(\d\d)-(\d\d)T/);var nowTime=`${now[1]}.${now[2]}.${now[3]}`;if(!this.searchConfigPlayList(toPlayList.idInPlatform.value,toPlayList.name.value,configPlayList.recordingList)&&(yield this.options.getSummaryAccept(this.options.translate.playListAdd({recording:snippetTitle,playList:toPlayList.name.value})))){var recording={idInPlatform:Object.assign({},plro.idInPlatform,{value:idInPlatform}),type:Object.assign({},plro.type,{value:idType}),name:Object.assign({},plro.name,{value:snippetTitle}),publishedAt:Object.assign({},plro.publishedAt,{value:new Date().toISOString()}),stoppedIn:Object.assign({},plro.stoppedIn),marks:Object.assign({},plro.marks,{value:[]})};toPlayList.updatedAt.value=nowTime;toPlayList.recordingList.unshift(recording);configPlayList.updatedAt.value=nowTime;configPlayList.recordingList.unshift(recording);yield this.options.configSave();}});function addToPlayList(_x13,_x14,_x15,_x16){return _addToPlayList.apply(this,arguments);}return addToPlayList;}()},{key:"getLastPlayedRecording",value:function getLastPlayedRecording(){var _this$lastPlayedRecor,_this$lastPlayedPlayL,_this$lastPlayedPlayL2,_this$lastPlayedPlayL3,_this$lastPlayedPlayL4;var getPreviousRecording=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;return((_this$lastPlayedRecor=this.lastPlayedRecording)==null?void 0:_this$lastPlayedRecor.recording)||((_this$lastPlayedPlayL=this.lastPlayedPlayList)==null?void 0:(_this$lastPlayedPlayL2=_this$lastPlayedPlayL.playList)==null?void 0:(_this$lastPlayedPlayL3=_this$lastPlayedPlayL2.recordingList)==null?void 0:_this$lastPlayedPlayL3[(_this$lastPlayedPlayL4=this.lastPlayedPlayList)==null?void 0:_this$lastPlayedPlayL4[getPreviousRecording?'previousRecordingIndex':'recordingIndex']]);}},{key:"search",value:function(){var _search=(0,_asyncToGenerator2.default)(function*(searchedKeywords){var _ref4=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},_ref4$channelId=_ref4.channelId,channelId=_ref4$channelId===void 0?undefined:_ref4$channelId,_ref4$maxResults=_ref4.maxResults,maxResults=_ref4$maxResults===void 0?1:_ref4$maxResults,_ref4$order=_ref4.order,order=_ref4$order===void 0?'relevance':_ref4$order,_ref4$publishedAfter=_ref4.publishedAfter,publishedAfter=_ref4$publishedAfter===void 0?undefined:_ref4$publishedAfter,_ref4$publishedBefore=_ref4.publishedBefore,publishedBefore=_ref4$publishedBefore===void 0?undefined:_ref4$publishedBefore,_ref4$relevanceLangua=_ref4.relevanceLanguage,relevanceLanguage=_ref4$relevanceLangua===void 0?undefined:_ref4$relevanceLangua,_ref4$type=_ref4.type,type=_ref4$type===void 0?undefined:_ref4$type;var results=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];var nextPageToken=arguments.length>3&&arguments[3]!==undefined?arguments[3]:undefined;console.debug('jjplugin: YouTube - search(',{searchedKeywords:searchedKeywords,channelId:channelId,maxResults:maxResults,order:order,publishedAfter:publishedAfter,publishedBefore:publishedBefore,relevanceLanguage:relevanceLanguage,type:type,nextPageToken:nextPageToken},')');var existingPlayList=type=='playList'&&this.searchConfigPlayList('',searchedKeywords.join(' '));if(existingPlayList)return[{snippet:{publishedAt:'1970-01-01T00:00:00Z',title:existingPlayList.name.value},id:{playlistId:existingPlayList.idInPlatform.value}}];var n=new Date();var url=this.options.config.playLists.youtubeAPIKey.value?new URL('https://www.googleapis.com/youtube/v3/search'):new URL('obsgrass.com:9999/api/youtube?url_='+encodeURIComponent('https://www.googleapis.com/youtube/v3/search'));url.searchParams.set('key',this.options.config.playLists.youtubeAPIKey.value);url.searchParams.set('part','snippet');url.searchParams.set('q',searchedKeywords.join(' '));channelId&&url.searchParams.set('channelId',channelId);maxResults&&url.searchParams.set('maxResults',(maxResults<0?50:maxResults)+'');order&&url.searchParams.set('order',order);publishedAfter&&url.searchParams.set('publishedAfter',publishedAfter);publishedBefore&&url.searchParams.set('publishedBefore',publishedBefore);relevanceLanguage&&url.searchParams.set('relevanceLanguage',relevanceLanguage);type&&url.searchParams.set('type',type);nextPageToken&&url.searchParams.set('pageToken',nextPageToken);url.searchParams.set('expirationISO',`${n.getUTCFullYear()}-${(n.getUTCMonth()+1).toString().padStart(2,'0')}-${(n.getUTCDate()+1).toString().padStart(2,'0')}T${n.getUTCSeconds().toString().padStart(2,'0')}:${n.getUTCMinutes().toString().padStart(2,'0')}:${n.getUTCHours().toString().padStart(2,'0')}.000Z`);var resultPart=yield fetch(url).then(function(){var _ref5=(0,_asyncToGenerator2.default)(function*(response){var result=yield response.json();if(response.status===200){if('error'in result)return Promise.reject(JSON.stringify(result,null,4));else return result;}else return Promise.reject(JSON.stringify(result,null,4));});return function(_x18){return _ref5.apply(this,arguments);};}());results=[].concat((0,_toConsumableArray2.default)(results),(0,_toConsumableArray2.default)(resultPart.items));if(channelId&&maxResults<0&&maxResults>-100&&resultPart.nextPageToken)return yield this.search(searchedKeywords,{channelId:channelId,maxResults:maxResults-1,order:order,publishedAfter:publishedAfter,publishedBefore:publishedBefore,relevanceLanguage:relevanceLanguage,type:type},results,resultPart.nextPageToken);else{console.debug('jjplugin: YouTube - search return: length =',results.length,'; id[0] =',results[0].id,'; title[0] =',results[0].snippet.title);return results;}});function search(_x17){return _search.apply(this,arguments);}return search;}()},{key:"getPlayList",value:function(){var _getPlayList=(0,_asyncToGenerator2.default)(function*(idInPlatform,idType,snippetTitle){var _result,_result2,_this4=this;var saveInConfig=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;var result=arguments.length>4&&arguments[4]!==undefined?arguments[4]:undefined;var nextPageToken=arguments.length>5&&arguments[5]!==undefined?arguments[5]:undefined;console.debug('jjplugin: YouTube - getPlayList(',{idInPlatform:idInPlatform,idType:idType,snippetTitle:snippetTitle,saveInConfig:saveInConfig,result:{idInPlatform:(_result=result)==null?void 0:_result.idInPlatform,name:(_result2=result)==null?void 0:_result2.name},nextPageToken:nextPageToken},')');var configPlayList=this.searchConfigPlayList(idInPlatform,snippetTitle);if(idInPlatform){var n=new Date();var url=this.options.config.playLists.youtubeAPIKey.value?new URL('https://www.googleapis.com/youtube/v3/'+(idType=='playList'?'playlistItems':'playlists')):new URL('obsgrass.com:9999/api/youtube?url_='+encodeURIComponent('https://www.googleapis.com/youtube/v3/'+(idType=='playList'?'playlistItems':'playlists')));url.searchParams.set('key',this.options.config.playLists.youtubeAPIKey.value);url.searchParams.set('part','snippet,contentDetails');url.searchParams.set(idType=='playList'?'playlistId':'channelId',idInPlatform);url.searchParams.set('maxResults','50');nextPageToken&&url.searchParams.set('pageToken',nextPageToken);url.searchParams.set('expirationISO',`${n.getUTCFullYear()}-${(n.getUTCMonth()+1).toString().padStart(2,'0')}-${(n.getUTCDate()+1).toString().padStart(2,'0')}T${n.getUTCSeconds().toString().padStart(2,'0')}:${n.getUTCMinutes().toString().padStart(2,'0')}:${n.getUTCHours().toString().padStart(2,'0')}.000Z`);var resultPart=yield fetch(url.href).then(function(){var _ref6=(0,_asyncToGenerator2.default)(function*(response){var result=yield response.json();if(response.status===200){if('error'in result)return Promise.reject(JSON.stringify(result,null,4));else return result;}else return Promise.reject(JSON.stringify(result,null,4));});return function(_x22){return _ref6.apply(this,arguments);};}());var plo=this.options.config.playLists.playLists[0];var plro=plo.recordingList[0];var now=new Date().toISOString().match(/^(\d\d\d\d)-(\d\d)-(\d\d)T/);var nowTime=`${now[1]}.${now[2]}.${now[3]}`;var newPlayList={platform:Object.assign({},plo.platform,{value:'YouTube'}),idInPlatform:Object.assign({},plo.idInPlatform,{value:idInPlatform}),name:Object.assign({},plo.idInPlatform,{value:snippetTitle}),updatedAt:Object.assign({},plo.updatedAt,{value:nowTime}),setMassStatus:Object.assign({},plo.setMassStatus),reloadEveryHours:Object.assign({},plo.reloadEveryHours),recordingList:[]};!configPlayList&&console.debug('jjplugin: YouTube - configPlayList not exists');if(!configPlayList&&saveInConfig){configPlayList=Object.assign({},newPlayList,{recordingList:[]});this.options.config.playLists.playLists.unshift(configPlayList);console.debug('jjplugin: YouTube - configPlayList is created');}if(configPlayList)saveInConfig=true;result??=Object.assign({},newPlayList,{recordingList:[]});var _loop=function*_loop(){var item=resultPart.items[i];if(configPlayList&&configPlayList.recordingList.find(function(r){return r.idInPlatform.value===(item.contentDetails.videoId||item.id);})){delete resultPart.nextPageToken;return 1;}else{var recording={idInPlatform:Object.assign({},plro.idInPlatform,{value:item.contentDetails.videoId}),type:Object.assign({},plro.type,{value:idType=='playList'?'recording':'playList'}),name:Object.assign({},plro.name,{value:item.snippet.title}),publishedAt:Object.assign({},plro.publishedAt,{value:item.snippet.publishedAt}),stoppedIn:Object.assign({},plro.stoppedIn),marks:Object.assign({},plro.marks,{value:[]})};if(idType=='playList')result.recordingList.splice(i,0,recording);if(configPlayList){configPlayList.recordingList.splice(i,0,recording);configPlayList.updatedAt.value=nowTime;}}if(idType=='channel')yield _this4.getPlayList(item.id,'playList',item.snippet.title,saveInConfig,result,undefined);};for(var i=0;i<resultPart.items.length;i++){if(yield*_loop())break;}if(resultPart.nextPageToken){return yield this.getPlayList(idInPlatform,idType,snippetTitle,saveInConfig,result,resultPart.nextPageToken);}}else{result??=Object.assign({},configPlayList,{recordingList:[]});}if(configPlayList){var _loop2=function*_loop2(){var rec=configPlayList.recordingList[_i];if(rec.type.value=='playList')yield _this4.getPlayList(rec.idInPlatform.value,idType,snippetTitle,saveInConfig,result);else if(!result.recordingList.find(function(r){return r.idInPlatform.value==rec.idInPlatform.value;}))result.recordingList.splice(_i,0,rec);};for(var _i=0;_i<configPlayList.recordingList.length;_i++){yield*_loop2();}yield this.options.configSave();}return result;});function getPlayList(_x19,_x20,_x21){return _getPlayList.apply(this,arguments);}return getPlayList;}()},{key:"shuffleArray",value:function shuffleArray(array){for(var i=array.length-1;i>=0;i--){var j=Math.floor(Math.random()*(i+1));var _ref7=[array[j],array[i]];array[i]=_ref7[0];array[j]=_ref7[1];}return array;}}]);}();